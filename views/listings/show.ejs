<%- layout('/layouts/boilerplate') %>

<!-- Responsive Container -->
<div class="container-fluid px-2 px-md-3 px-lg-4">
    <div class="row justify-content-center">
        <!-- Main Content Column -->
        <div class="col-12 col-lg-10 col-xl-8">
            <!-- Title Section -->
            <div class="text-center mb-4">
                <h2 class="h1 mb-0"><%= listing.title %></h2>
            </div>    

            <!-- Listing Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="position-relative">
                    <img src="<%= listing.image.url %>" class="card-img-top img-fluid" alt="listing_image" style="height: 400px; object-fit: cover;">
                </div>
                <div class="card-body p-3 p-md-4">
                    <div class="row">
                        <div class="col-12 col-md-8">
                            <p class="card-text mb-2"><strong>Owned by</strong> <i><%= listing.owner.username %></i></p>
                            <p class="card-text mb-3"><%= listing.description %></p>
                            <p class="card-text mb-2">
                                <span class="h4 text-primary">&#8377;<%= listing.price.toLocaleString("en-IN") %></span>
                                <span class="text-muted">/ night</span>
                            </p>
                            <p class="card-text text-muted">
                                <i class="fa-solid fa-location-dot me-1"></i>
                                <%= listing.location %>, <%= listing.country %>
                            </p>
                        </div>
                        <div class="col-12 col-md-4 d-flex flex-column justify-content-end">
                            <!-- Edit/Delete Buttons -->
                            <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
                            <div class="d-flex flex-column flex-sm-row gap-2 mb-3">
                                <a class="btn btn-dark px-4" href="/listings/<%= listing._id %>/edit">
                                    <i class="fa-solid fa-edit me-1"></i>Edit
                                </a>
                                <form class="m-0" action="/listings/<%= listing._id %>?_method=DELETE" method="post">
                                    <button class="btn btn-outline-danger px-4 w-100" type="submit">
                                        <i class="fa-solid fa-trash me-1"></i>Delete
                                    </button>
                                </form>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="mb-4">
                <hr class="my-4">
                <% if(currUser) { %>
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-3 p-md-4">
                        <h4 class="mb-3">
                            <i class="fa-solid fa-star me-2 text-warning"></i>Leave a Review
                        </h4>
                        <form action="/listings/<%= listing._id %>/reviews" method="post" class="needs-validation">
                            <div class="mb-3">
                                <label class="form-label fw-semibold" for="rating">Rating</label>
                                <fieldset class="starability-slot">
                                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                    <label for="first-rate1" title="Terrible">1 star</label>
                                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                    <label for="first-rate2" title="Not good">2 stars</label>
                                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                    <label for="first-rate3" title="Average">3 stars</label>
                                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                    <label for="first-rate4" title="Very good">4 stars</label>
                                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                    <label for="first-rate5" title="Amazing">5 stars</label>
                                </fieldset>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold" for="comment">Comments</label>
                                <textarea class="form-control" name="review[comment]" id="comment" rows="4" required placeholder="Share your experience..."></textarea>
                                <div class="invalid-feedback">Please add some comments for review</div>
                            </div>
                            <button class="btn btn-primary px-4" type="submit">
                                <i class="fa-solid fa-paper-plane me-1"></i>Submit Review
                            </button>
                        </form>
                    </div>
                </div>
                <% } %>

                <% if (listing.reviews && listing.reviews.length) { %>
                <div class="mb-4">
                    <h4 class="mb-3">
                        <i class="fa-solid fa-comments me-2 text-primary"></i>
                        <strong>All Reviews</strong>
                        <span class="badge bg-secondary ms-2"><%= listing.reviews.length %></span>
                    </h4>
                    <div class="row g-3">
                    <% listing.reviews.forEach(review => { %>
                        <div class="col-12 col-lg-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                    <span class="fw-semibold text-primary">@<%= review.author.username %></span>
                                    <span class="starability-result" data-rating=<%= review.rating %>></span>
                                </div>
                                <div class="card-body p-3">
                                    <p class="card-text mb-0"><%= review.comment %></p>
                                </div>
                                <% if(currUser && review.author._id.equals(currUser._id)) { %>
                                <div class="card-footer bg-transparent border-0 pt-0 pb-3 px-3">
                                    <form class="m-0" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="post">
                                        <button class="btn btn-sm btn-outline-danger" type="submit">
                                            <i class="fa-solid fa-trash me-1"></i>Delete
                                        </button>
                                    </form>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    <% }) %>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Map Section -->
<div class="container-fluid px-2 px-md-3 px-lg-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-0">
                    <h3 class="text-center mb-3 p-3 pb-0">
                        <i class="fa-solid fa-map-location-dot me-2 text-primary"></i>Where you'll be
                    </h3>
                    <div id="map" 
                         data-geometry='<%- JSON.stringify(listing.geometry || null) %>' 
                         data-title="<%= listing.title %>" 
                         data-location="<%= listing.location %>" 
                         data-country="<%= listing.country %>"
                         style="height: 400px; width: 100%; border-radius: 0 0 0.375rem 0.375rem;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Map initialization -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const mapEl = document.getElementById('map');
    let geometry = null;
    try {
        geometry = JSON.parse(mapEl.dataset.geometry || 'null');
    } catch (e) {
        geometry = null;
    }
    const listingData = {
        geometry,
        title: mapEl.dataset.title,
        location: mapEl.dataset.location,
        country: mapEl.dataset.country
    };
    // Initialize map with simple, working controls
    const map = L.map('map', {
        center: [0, 0],
        zoom: 2
    });

    // Add simple tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);

    // Simple function to add marker and set view
    function addMarkerAndSetView(lat, lon, title, location, country) {
                map.setView([lat, lon], 13);

                L.marker([lat, lon])
                    .addTo(map)
            .bindPopup(`<b>${title}</b><br>${location}, ${country}`)
                    .openPopup();
    }

    // Prefer stored geometry if available; otherwise fall back to client geocoding
    if (listingData && listingData.geometry && listingData.geometry.type === 'Point' && Array.isArray(listingData.geometry.coordinates) && listingData.geometry.coordinates.length === 2) {
        const lon = listingData.geometry.coordinates[0];
        const lat = listingData.geometry.coordinates[1];
        addMarkerAndSetView(lat, lon, listingData.title, listingData.location, listingData.country);
    } else if (listingData && listingData.location && listingData.country) {
        const q = encodeURIComponent(`${listingData.location}, ${listingData.country}`);
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`, {
            headers: { 'User-Agent': 'wanderlust-app/1.0' }
        })
            .then(res => res.json())
            .then(data => {
                if (data[0]) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    addMarkerAndSetView(lat, lon, listingData.title, listingData.location, listingData.country);
                }
            })
            .catch(err => {
                console.log('Geocoding failed:', err);
                // Show world view if geocoding fails
                map.setView([20, 0], 2);
            });
    } else {
        // Show world view if no location data
        map.setView([20, 0], 2);
    }

});
</script>


